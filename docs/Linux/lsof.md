lsof（List Open Files）是Unix/Linux系统中用于列出所有打开文件的命令行工具。在类Unix系统中，“文件”的概念非常宽泛（包括普通文件、目录、管道、套接字、设备等），因此lsof可用于排查进程占用、文件锁定、网络连接等多种系统问题。

一、基本概念
● 作用：列出系统中所有被进程打开的文件（包括网络套接字、设备、管道等）。
● 权限：普通用户只能查看自己进程打开的文件；root用户可查看所有进程的文件。
● 输出列含义：执行lsof后，输出通常包含以下列（不同系统可能略有差异）：
  ○ COMMAND：打开文件的进程名
  ○ PID：进程ID
  ○ USER：进程所属用户
  ○ FD：文件描述符（如0=标准输入、1=标准输出、2=错误输出、u=可读可写）
  ○ TYPE：文件类型（如REG=普通文件、DIR=目录、IPv4=TCP/UDP连接、FIFO=管道）
  ○ DEVICE：设备编号（格式为major:minor）
  ○ SIZE/OFF：文件大小或偏移量
  ○ NODE：文件的inode节点号
  ○ NAME：文件名或网络地址（如socket路径、IP:端口）

二、常用选项与示例
lsof的选项非常丰富，以下是最常用的场景和用法：

1. 基础用法：列出所有打开的文件
直接执行lsof（默认输出所有进程打开的文件，内容较多，通常结合过滤使用）：
lsof  # 列出所有打开的文件（需root权限才能看全）

2. 按文件名/目录过滤
● 查找指定文件被哪些进程打开：
lsof /var/log/syslog  # 查看/var/log/syslog被哪些进程打开
● 递归查找目录下所有文件被打开的情况（+D表示递归，+d表示非递归）：
lsof +D /var/log  # 递归查看/var/log目录下所有文件的打开情况

3. 按进程过滤
● 按进程ID（PID）查找：查看指定进程打开的所有文件
lsof -p 1234  # 查看PID=1234的进程打开的文件
lsof -p 1234,5678  # 同时查看多个PID（用逗号分隔）
lsof -p ^1234  # 排除PID=1234的进程（^表示排除）
● 按进程名查找：查看名称包含指定字符串的进程打开的文件（-c后接进程名前缀）
lsof -c ssh  # 查看所有以"ssh"开头的进程（如sshd、ssh）打开的文件
lsof -c "java"  # 查看名称包含"java"的进程

4. 按用户过滤
● 查看指定用户打开的所有文件：
lsof -u alice  # 查看用户alice打开的文件
lsof -u alice,root  # 查看用户alice和root打开的文件
lsof -u ^root  # 排除root用户的文件

5. 网络相关：查看网络连接
lsof -i是排查网络问题的核心用法，可查看TCP/UDP连接、端口占用等。
● 列出所有网络连接（包括TCP、UDP）：
lsof -i  # 所有网络相关的打开文件（套接字等）
● 按协议过滤（TCP/UDP）：
lsof -i tcp  # 仅显示TCP连接
lsof -i udp  # 仅显示UDP连接
● 按端口过滤（最常用！定位端口被哪个进程占用）：
lsof -i :8080  # 查看占用8080端口的进程
lsof -i tcp:80  # 查看TCP协议的80端口占用
● 按IP地址过滤：
lsof -i @192.168.1.100  # 查看与192.168.1.100的网络连接
lsof -i tcp@192.168.1.100:80  # 查看与192.168.1.100:80的TCP连接
● 按连接状态过滤（结合grep）：
lsof -i tcp | grep ESTABLISHED  # 查看所有已建立的TCP连接
lsof -i tcp | grep LISTEN  # 查看所有监听状态的TCP端口

6. 其他实用场景
● 查找被删除但仍被进程占用的文件（这类文件会占用磁盘空间，直到进程释放）：
lsof +L1  # 列出所有已删除（链接数为0）但仍被打开的文件
lsof +L1 | grep -i deleted  # 更直观显示"deleted"标记的文件
● 按文件描述符过滤（FD列）：
lsof -d 0  # 查看所有进程的标准输入（FD=0）
lsof -d 1-2  # 查看标准输出（1）和错误输出（2）
lsof -d 10  # 查看文件描述符为10的文件
● 实时刷新输出（每隔N秒刷新一次）：
lsof -r 2  # 每2秒刷新一次输出（按Ctrl+C退出）

三、常见问题示例
1. 问题：启动服务时提示“端口被占用”，如何定位占用进程？
解决：lsof -i :端口号，例如：
lsof -i :8080  # 找到占用8080端口的PID，再用kill PID终止
2. 问题：删除文件后磁盘空间未释放，如何处理？
解决：用lsof +L1找到占用已删除文件的进程，重启该进程释放空间：
lsof +L1 | grep /var/log/old.log  # 找到占用old.log的进程PID
kill -9 1234  # 重启进程（1234为PID）
3. 问题：查看某个进程是否打开了特定网络连接？
解决：结合进程ID和网络选项：
lsof -p 1234 -i  # 查看PID=1234的进程所有网络连接

总结
lsof是系统管理和问题排查的核心工具，尤其在定位端口占用、文件锁定、网络连接等场景中不可替代。熟练掌握-i（网络）、-p（进程）、-u（用户）等选项，可快速解决大部分系统资源占用问题。